(function () {
	'use strict';

	var e=(e,t,s)=>new Promise(((n,o)=>{var i=e=>{try{a(s.next(e));}catch(t){o(t);}},l=e=>{try{a(s.throw(e));}catch(t){o(t);}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,l);a((s=s.apply(e,t)).next());})),t={toyThemesList:[{name:"初春 Spring",value:"spring",type:"daylight"},{name:"深秋 Autumn",value:"autumn",type:"daylight"},{name:"凛冬 Winter",value:"winter",type:"daylight"},{name:"今夜 Tonight",value:"tonight",type:"midnight"},{name:"护眼 Green",value:"green",type:"daylight"},{name:"海蓝 Blue",value:"blue",type:"midnight"},{name:"幽兰 Cyan",value:"Cyan",type:"midnight"}]};class s{constructor(e){this.init(e);}init(t){return e(this,null,(function*(){this.setting=t,this.hasToy=yield this.hasToyTheme(),this.createToolbar();}))}hasToyTheme(){return new Promise(((e,t)=>{fetch("http://127.0.0.1:6806/appearance/themes/toy/theme.css").then((t=>{200==t.status?e(!0):(console.log("未安装 Toy 主题，err："+t.status),e(!1));})).catch((e=>t(e)));}))}changeTheme(e,t,s="common"){this.themeDefaultStyle=document.querySelector("#themeDefaultStyle"),this.themeStyle=document.querySelector("#themeStyle"),this.themeDefaultStyle.href="daylight"==t?this.themeDefaultStyle.href.replace(/themes\/(\S+)\/theme\.css/g,"themes/daylight/theme.css"):this.themeDefaultStyle.href.replace(/themes\/(\S+)\/theme\.css/g,"themes/midnight/theme.css");let n=document.querySelector("#toy-theme");switch(s){case"toy":this.themeStyle.href=this.themeStyle.href.replace(/themes\/(\S+)\/theme\.css/g,`themes/${t}/theme.css`);let s=`@import url("http://127.0.0.1:6806/appearance/themes/toy/palette/${e}.css");@import url("http://127.0.0.1:6806/appearance/themes/toy/base.css");`;if(n)n.innerText=s;else {n=document.createElement("style"),n.id="toy-theme",n.innerText=s;let e=document.querySelector("#custom-css");e?document.head.insertBefore(n,e):document.head.appendChild(n);}break;default:n&&(n.innerText=""),this.themeStyle.href=this.themeStyle.href.replace(/themes\/(\S+)\/theme\.css/g,`themes/${e}/theme.css`);}}createToolbar(){this.toolbar=document.createElement("div"),this.toolbar.id="lz-toolbar",this.toolbar.classList.add("close"),document.body.appendChild(this.toolbar);let e=document.createElement("i");e.title="切换主题",e.id="btn-theme",e.classList.add("toolbar-btn","el-icon-brush");let t=document.createElement("i");t.title="功能菜单",t.id="btn-action",t.classList.add("toolbar-btn","el-icon-suitcase");let s=document.createElement("i");s.title="设置",s.id="btn-set",s.classList.add("toolbar-btn","el-icon-set-up");let n=document.createElement("i");if(n.id="btn-close",n.classList.add("toolbar-btn","closeBtn","el-icon-d-arrow-right"),n.addEventListener("click",(()=>{this.toolbar.classList.contains("close")?(n.classList.remove("el-icon-d-arrow-left"),n.classList.add("el-icon-d-arrow-right"),this.toolbar.classList.remove("close")):(n.classList.remove("el-icon-d-arrow-right"),n.classList.add("el-icon-d-arrow-left"),this.toolbar.classList.add("close"));})),this.toolbar.appendChild(e),this.toolbar.appendChild(s),this.toolbar.appendChild(n),this.themeMenu=document.createElement("div"),this.themeMenu.id="menu-theme",this.themeMenu.classList.add("menu"),this.hasToy){let e=document.createElement("div");e.id="theme-toy-default",e.innerHTML='Toy 🛺  <i class="el-icon-arrow-right"></i>',e.classList.add("menu-item"),this.themeMenu.appendChild(e);let t=document.createElement("div");t.id="theme-toy-submenu",t.classList.add("submenu"),this.themeMenu.appendChild(t);let s=this.setting.config.toyThemesList;if(s)for(let n=0;n<s.length;n++){const e=s[n];let o=document.createElement("div");o.id=`theme-toy-${e.value}`,o.innerText=e.name,o.classList.add("menu-item"),o.addEventListener("click",(()=>{this.changeTheme(e.value,e.type,"toy");}),!1),t.appendChild(o);}t.addEventListener("mouseout",(e=>{e.stopPropagation(),e.cancelBubble=!0,e.toElement.id&&e.toElement.id.indexOf("theme-toy")>-1||this.closeMenus("self","submenu","theme-toy-submenu");})),t.addEventListener("mouseover",(e=>{e.stopPropagation(),e.cancelBubble=!0;})),e.addEventListener("mouseover",(e=>{e.stopPropagation(),e.cancelBubble=!0,t.classList.add("show");let s=e.toElement.parentElement.offsetLeft,n=e.toElement.parentElement.offsetTop,o=t.clientHeight;t.clientWidth,t.style.right=document.documentElement.clientWidth-s+5+"px",n+o>document.body.clientHeight?t.style.top=document.documentElement.clientHeight-o-5+"px":t.style.top=n+"px";})),e.addEventListener("mouseout",(e=>{e.offsetX>0&&-1==e.toElement.id.indexOf("theme-toy")&&t.classList.remove("show");}));}let o=this.setting.user.lightThemes,i=this.setting.user.darkThemes;if(o){o=o.split("|");for(let e=0;e<o.length;e++){const t=o[e].replace(/(^\s*)|(\s*$)/g,"");if(t){let e=document.createElement("div");e.id=`theme-${t}`,e.innerText=t,e.classList.add("menu-item"),e.addEventListener("click",(()=>{this.changeTheme(t,"daylight");}),!1),this.themeMenu.appendChild(e);}}}if(i){i=i.split("|");for(let e=0;e<i.length;e++){const t=i[e].replace(/(^\s*)|(\s*$)/g,"");if(t){let e=document.createElement("div");e.id=`theme-${t}`,e.innerText=t,e.classList.add("menu-item"),e.addEventListener("click",(()=>{this.changeTheme(t,"midnight");}),!1),this.themeMenu.appendChild(e);}}}this.toolbar.appendChild(this.themeMenu),this.actionMenu=document.createElement("div"),this.actionMenu.id="menu-action",this.actionMenu.classList.add("menu"),this.toolbar.appendChild(this.actionMenu),this.randomWalkBtn=document.createElement("div"),this.randomWalkBtn.id="random-walk",this.randomWalkBtn.innerText="随机漫步",this.randomWalkBtn.classList.add("menu-item"),this.actionMenu.appendChild(this.randomWalkBtn),this.attrsPanelBtn=document.createElement("div"),this.attrsPanelBtn.id="attrs-panel",this.attrsPanelBtn.innerText="属性面板",this.attrsPanelBtn.classList.add("menu-item"),this.actionMenu.appendChild(this.attrsPanelBtn),this.setMenu=document.createElement("div"),this.setMenu.id="menu-set",this.setMenu.classList.add("menu"),this.toolbar.appendChild(this.setMenu),this.optionsBtn=document.createElement("div"),this.optionsBtn.id="options-btn",this.optionsBtn.innerText="插件配置",this.optionsBtn.classList.add("menu-item"),this.setMenu.appendChild(this.optionsBtn),this.optionsBtn.addEventListener("click",(()=>{chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("libs_options.html"));})),this.clearOptionsBtn=document.createElement("div"),this.clearOptionsBtn.id="clear-btn",this.clearOptionsBtn.innerText="清空配置",this.clearOptionsBtn.classList.add("menu-item"),this.setMenu.appendChild(this.clearOptionsBtn),this.clearOptionsBtn.addEventListener("click",(()=>{chrome.storage.local.clear((()=>{!function(e){let t=document.querySelector("#snackbar");t||(t=document.createElement("div"),t.id="snackbar",document.body.appendChild(t)),t.className="show",t.innerText=e,setTimeout((function(){t.className=t.className.replace("show","");}),3e3);}("配置已清空");}));})),document.querySelectorAll("#lz-toolbar .toolbar-btn").forEach(((e,t,s)=>{e.id&&e.addEventListener("click",(t=>{if(e.classList.contains("show"))e.classList.remove("show"),this.closeMenus("self","btn",e.id);else {this.closeMenus("others","btn",e.id);let s=e.id.replace("btn","menu"),n=document.querySelector(`#lz-toolbar #${s}`);if(n){let s=t.clientX-50;s+180>=document.documentElement.clientWidth?n.style.right="60px":n.style.left=s+"px",n.classList.add("show"),e.classList.add("show"),this.menuMask.style.display="block";}}}));})),document.querySelectorAll("#lz-toolbar .menu-item").forEach(((e,t,s)=>{e.addEventListener("click",(e=>{document.querySelectorAll("#lz-toolbar .show").forEach(((e,t,s)=>{e.classList.remove("show");}));}));})),this.menuMask=document.createElement("div"),this.menuMask.classList.add("menu-mask"),document.body.appendChild(this.menuMask),this.menuMask.addEventListener("click",(()=>{this.closeMenus(),this.menuMask.style.display="none";}));}closeMenus(e,t,s){let n,o;switch(e){case"self":if(!t||!s)return !1;"btn"==t&&(o=s.replace("btn","menu")),"menu-item"==t&&(o=document.querySelector(`#${s}`).parentNode.id),"submenu"==t&&(o=s),n=document.querySelector(`#lz-toolbar #${o}`),n.classList.remove("show");break;case"others":if(!t||!s)return !1;let e,i;"btn"==t&&(o=s.replace("btn","menu")),"menu-item"==t&&(o=document.querySelector(`#${s}`).parentNode.id),e=document.querySelectorAll(`#lz-toolbar :not(#${o}).toolbar-btn`),e.forEach(((e,t,s)=>{e.classList.remove("show");})),i=document.querySelectorAll(`#lz-toolbar :not(#${o}).menu`),i.forEach(((e,t,s)=>{e.classList.remove("show");}));break;default:document.querySelectorAll("#lz-toolbar .menu").forEach(((e,t,s)=>{e.classList.remove("show");})),document.querySelectorAll("#lz-toolbar .toolbar-btn").forEach(((e,t,s)=>{e.classList.remove("show");}));}}}class n{constructor(e,t,s){if(!e)throw "拖拽对象为空";this.el=e,this.mx=null,this.my=null,this.ox=null,this.oy=null,this.movefn=t,this.endfn=s;}init(){this.el.onmousedown=e=>{e=this.e(e),this.o=e.target,this.ox=parseInt(this.o.offsetLeft),this.oy=parseInt(this.o.offsetTop),this.mx=e.mx,this.my=e.my,this.el.onmousemove=e=>this.move(e,this),this.el.onmouseup=e=>this.stop(e,this);};}e(e){return e||((e=window.event).target=e.srcElement,e.layerX=e.offsetX,e.layerY=e.offsetY),e.mx=e.pageX||e.clientX+document.body.scrollLeft,e.my=e.pageY||e.clientY+document.body.scrollTop,e}move(e,t){e=t.e(e),this.movefn(t.mx,e.mx,t.my,e.my);}stop(e,t){e=t.e(e),t.ox=parseInt(t.o.offsetLeft),t.oy=parseInt(t.o.offsetTop),t.mx=e.mx,t.my=e.my,this.endfn(t.mx,t.my),t.onmousedown=t.el.onmousemove=t.el.onmouseup=null;}end(){this.el=this.el.onmousedown=null;}}class o{constructor(){this.element=null,setTimeout((()=>{this.initDrag();}),2e3);}initDrag(){document.querySelectorAll(".layout__center.fn__flex.fn__flex-1 .protyle").forEach(((e,t,s)=>{this.creatBtn(e);}));}creatBtn(e){let t,s=e.querySelector(".protyle-breadcrumb__bar > .protyle-breadcrumb__item:first-child");s=s.getAttribute("data-node-id");let o=e.querySelector(".protyle-background .protyle-icons"),i=o.parentNode;if(s&&o){let e=document.createElement("span");e.classList.add("b3-tooltips","b3-tooltips__s"),e.setAttribute("data-action","move"),e.setAttribute("aria-label","调整位置"),e.innerHTML='<svg class="svg"><use xlink:href="#iconMove"></use></svg>',o.appendChild(e);let l=document.createElement("span");l.classList.add("drag-cover-btn"),l.setAttribute("aria-label","完成头图调整"),l.innerText="保存",l.style.opacity=0,l.style.display="none",o.appendChild(l);let a=document.createElement("span");a.classList.add("drag-cover-btn"),a.setAttribute("aria-label","取消头图调整"),a.innerText="取消",a.style.opacity=0,a.style.display="none",o.appendChild(a),e.addEventListener("click",(()=>{-1!=i.style.backgroundImage.indexOf("url")?(t=new n(i,((e,t,s,n)=>this.moveHandle(e,t,s,n,i)),((e,t)=>this.endHandle(e,t))),t.init(),this.showMoveBtns(!0,i)):alert("无头图或官方头图不支持拖动");})),l.addEventListener("mousedown",(e=>{e.stopPropagation();})),a.addEventListener("mousedown",(e=>{e.stopPropagation();})),l.addEventListener("click",(e=>{e.stopPropagation(),console.log(t),console.log("保存头图"),t.end(),t=null,this.showMoveBtns(!1,i),this.saveCoverPosition(i,s);})),a.addEventListener("click",(e=>{e.stopPropagation(),console.log("取消保存头图"),t.end(),t=null,this.showMoveBtns(!1,i);}));}else setTimeout((()=>this.creatBtn()),400);}moveHandle(e,t,s,n,o){let i=o.style.backgroundPositionY;i=i.indexOf("%")>-1?parseFloat(i.replace("%","")):50;let l=(e-t)/o.clientWidth*100+50;l=l.toFixed(2)+"%";let a=(s-n)/o.clientHeight*100+i;a=a>100?100:a,a=a<0?0:a,a=a.toFixed(2)+"%",o.style.backgroundPosition=`50% ${a}`;}endHandle(e,t){}showMoveBtns(e,t){if(e){t.querySelectorAll(".b3-tooltips.b3-tooltips__s").forEach(((e,t,s)=>{e.style.opacity=0,e.style.display="none";})),t.querySelectorAll(".protyle-background .drag-cover-btn").forEach(((e,t,s)=>{e.style.opacity=1,e.style.display="block";}));}else {t.querySelectorAll(".protyle-background .drag-cover-btn").forEach(((e,t,s)=>{e.style.opacity=0,e.style.display="none";})),t.querySelectorAll(".b3-tooltips.b3-tooltips__s").forEach(((e,t,s)=>{e.style.opacity=1,e.style.display="block";}));}}saveCoverPosition(e,t){let s=e.getAttribute("style"),n=e.style.backgroundPosition;s=s.replace(/background\-position*;/,`background-position:${n}`),s=s.replace(/"/g,"'");const o={id:t,attrs:{"title-img":s}};fetch("http://127.0.0.1:6806/api/attr/setBlockAttrs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then((e=>e.json())).then((e=>{}));}}class i{constructor(){let s=this;chrome.storage.local.get(["setting"],(function(n){return e(this,null,(function*(){let e=!(!n.setting||"{}"==JSON.stringify(n.setting.user))&&n.setting.user;s.setting={config:t,user:e},s.load();}))}));}load(){this.addFontface(),this.addCustomCSS(),this.domWatcher(),new s(this.setting),this.dragCover=new o;}childListChangedHook(e){if(e.addedNodes){let t=e.addedNodes.item(0);t&&"fn__flex-1"==t.className&&setTimeout((()=>{this.dragCover.creatBtn(t);}),1e3);}}domWatcher(){var e=document.querySelector(".layout__center.fn__flex.fn__flex-1");if(e){const t={attributes:!1,childList:!0,subtree:!0};let s=this;new MutationObserver((function(e,t){for(let n of e)"childList"===n.type?s.childListChangedHook(n):"attributes"===n.type&&console.log("The "+n.attributeName+" attribute was modified.");})).observe(e,t);}else setTimeout((()=>{this.domWatcher();}),300);}addCustomCSS(){let e=document.querySelector("#protyleRevealStyle");if(e){let t=document.createElement("style");t.innerText=this.setting.user.customCss,t.id="custom-css",document.head.insertBefore(t,e);}else setTimeout((()=>{this.addCustomCSS();}),300);}addFontface(){let e=chrome.runtime.getURL("element-icons.ttf"),t=`@font-face{font-family:element-icons;src:url(${chrome.runtime.getURL("element-icons.woff")}) format("woff"),url(${e}) format("truetype");font-weight:400;font-display:"auto";font-style:normal}`,s=document.createElement("style");s.innerText=t,document.head.appendChild(s);}sendMsg(){chrome.runtime.sendMessage({msg:"hello,bakcground"},(function(e){console.log(e);}));}}window.onload=()=>{new i;};

}());
